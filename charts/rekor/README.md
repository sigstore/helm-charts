# rekor

[Rekor](https://github.com/sigstore/rekor) provides a restful API based server for validation and a transparency log for storage.

The following components are included by default:

* [MySQL](https://www.mysql.com)
* [Redis](https://redis.io)
* [Trillian Log Server](https://github.com/google/trillian)
* [Trillian Log Signer](https://github.com/google/trillian)

## Quick Installation

```shell
$ helm install [RELEASE_NAME] .
```

This command deploys the default configuration for the rekor chart. The [Parameters] section describes the various ways in which the chart can be configured.

## Uninstallation

```shell
$ helm uninstall [RELEASE_NAME]
```

The previous command removes the previously installed chart.

## Parameters

The following table lists the configurable parameters of the Rekor chart and their default values.

| Parameter                 | Description                                     | Default                                                 |
|---------------------------|-------------------------------------------------|---------------------------------------------------------|
| `imagePullSecrets`    | Registry secret names as an array                    | `[]`                                                   |
| `forceNamespace` | Explicitly specify the namespace to deploy the chart | `nil` |

### MySQL

| Parameter                 | Description                                     | Default                                                 |
|---------------------------|-------------------------------------------------|---------------------------------------------------------|
| `mysql.enabled`    | Deploy the MySQL component                    | `true`                                                   |
| `mysql.replicaCount` | Number of replicas to deploy | `1` |
| `mysql.hostname` | Hostname of the MySQL instance | `""` |
| `mysql.port` | Hostname of the MySQL instance | `3306` |
| `mysql.args` | Default container args  | `['--ignore-db-dir=lost+found']` |
| `mysql.name` | Name of the MySQL component | `mysql` |
| `mysql.image.repository` | Repository of the MySQL image | `gcr.io/trillian-opensource-ci/db_server` |
| `mysql.image.pullPolicy` | MySQL image pull policy | `IfNotPresent` |
| `mysql.image.version` | MySQL tag or image ID | `5e12fb368c8fd19e10aeb5a5cf785107f8069c08` |
| `mysql.resources` | MySQL compute resources | `{}` |
| `mysql.livenessProbe` | MySQL liveness probe configuration | Check `values.yaml` file |
| `redis.readinessProbe` | MySQL readiness probe configuration | Check `values.yaml` file |
| `mysql.service.type` | Kubernetes Service type | `ClusterIP` |
| `mysql.service.ports` | Kubernetes Service type | Check `values.yaml` file |
| `mysql.serviceAccount.create` | Create a dedicated Service Account for MySQL | `true` |
| `mysql.serviceAccount.name` | Name of the dedicated Service Account for MySQL | `""` |
| `mysql.serviceAccount.annotations` | Annotations to apply on the dedicated Service Account for Redis | `{}` |
| `mysql.secret.annotations` | Annotations to apply on the secret containing MySQL credentials | `{}` |
| `mysql.auth.existingSecret` | Name of the existing secret containing MySQL credentials | `""` |
| `mysql.auth.username` | MySQL username | `mysql` |
| `mysql.auth.password` | MySQL password | `""` (Autogenerated when empty) |
| `mysql.auth.rootPassword` | MySQL root password | `""` (Autogenerated when empty) |
| `mysql.persistence.enabled` | Enable persistent storage | `true` |
| `mysql.persistence.annotations` | Annotations to apply on the _PersistentVolumeClaim_ | `{}` |
| `mysql.persistence.storageClassName` | Name of the Storage Class | `nil` |
| `mysql.persistence.size` | Storage size to request | `5Gi` |
| `mysql.persistence.mountPath` | Location in container to mount storage | `/var/lib/mysql` |
| `mysql.persistence.subPath` | Mount subpath | `""` |
| `mysql.persistence.existingClaim` | Name of the exist_PersistentVolumeClaim_ing  to use for storage | `""` |
| `mysql.persistence.accessModes` | Access modes to request for the _PersistentVolumeClaim_ | `["ReadWriteOnce"]` |
| `mysql.deploymentAnnotations` | Annotations to apply on the Deployment | `{}` |
| `mysql.schedulerName` | Scheduler name to use | `nil` |
| `mysql.strategy` | Update Strategy | `nil` |
| `mysql.podAnnotations` | Annotations to apply on the MySQL Pod | `nil` |
| `mysql.podLabels` | Labels to apply on the MySQL Pod | `nil` |
| `mysql.extraInitContainers` | Extra `initContainers` to inject into the Deployment | `nil` |
| `mysql.priorityClassName` | Name of the Priority Class | `nil` |
| `mysql.nodeSelector` | Node Selector | `nil` |
| `mysql.dnsConfig` | DNS Configuration for the pod | `nil` |
| `mysql.securityContext` | Pod security context | `nil` |
| `mysql.tolerations` | Tolerations applied to the pod | `nil` |
| `mysql.affinity` | Pod affinity | `nil` |

### Redis

| Parameter                 | Description                                     | Default                                                 |
|---------------------------|-------------------------------------------------|---------------------------------------------------------|
| `redis.enabled`    | Deploy the Redis component                    | `true`                                                   |
| `redis.replicaCount` | Number of replicas to deploy | `1` |
| `redis.hostname` | Hostname of the Redis instance | `""` |
| `redis.port` | Hostname of the Redis instance | `6379` |
| `redis.args` | Default container args  | `['--bind', '0.0.0.0', '--appendonly', '"yes"']` |
| `redis.name` | Name of the Redis component | `redis` |
| `redis.image.repository` | Repository of the Redis image | `redis` |
| `redis.image.pullPolicy` | Redis image pull policy | `IfNotPresent` |
| `redis.image.version` | Redis tag or image ID | `5.0.10` |
| `redis.resources` | Redis compute resources | `{}` |
| `redis.livenessProbe` | Redis liveness probe configuration | Check `values.yaml` file |
| `redis.readinessProbe` | Redis readiness probe configuration | Check `values.yaml` file |
| `redis.service.type` | Kubernetes Service type | `ClusterIP` |
| `redis.service.ports` | Kubernetes Service type | Check `values.yaml` file |
| `redis.serviceAccount.create` | Create a dedicated Service Account for Redis | `true` |
| `redis.serviceAccount.name` | Name of the dedicated Service Account for Redis | `""` |
| `redis.serviceAccount.annotations` | Annotations to apply on the dedicated Service Account for Redis | `{}` |
| `redis.deploymentAnnotations` | Annotations to apply on the Deployment | `{}` |
| `redis.schedulerName` | Scheduler name to use | `nil` |
| `redis.strategy` | Update Strategy | `nil` |
| `redis.podAnnotations` | Annotations to apply on the Redis Pod | `nil` |
| `redis.podLabels` | Labels to apply on the Redis Pod | `nil` |
| `redis.extraInitContainers` | Extra `initContainers` to inject into the Deployment | `nil` |
| `redis.priorityClassName` | Name of the Priority Class | `nil` |
| `redis.nodeSelector` | Node Selector | `nil` |
| `redis.dnsConfig` | DNS Configuration for the pod | `nil` |
| `redis.securityContext` | Pod security context | `nil` |
| `redis.tolerations` | Tolerations applied to the pod | `nil` |
| `redis.affinity` | Pod affinity | `nil` |


### Server

| Parameter                 | Description                                     | Default                                                 |
|---------------------------|-------------------------------------------------|---------------------------------------------------------|
| `server.enabled`    | Deploy the Server component                    | `true`                                                   |
| `server.replicaCount` | Number of replicas to deploy | `1` |
| `server.hostname` | Hostname of the Server instance | `""` |
| `server.port` | Hostname of the Server instance | `3000` |
| `server.args` | Default container args  | `['--bind', '0.0.0.0', '--appendonly', '"yes"']` |
| `server.name` | Name of the Server component | `server` |
| `server.image.repository` | Repository of the Server image | `quay.io/ablock/rekor-server` |
| `server.image.pullPolicy` | Server image pull policy | `IfNotPresent` |
| `server.image.version` | Server tag or image ID | `latest` |
| `server.logging.production` | Enable production logging | `false` |
| `server.ingress.enabled` | Create an Ingress resource | `true` |
| `server.ingress.hostname` | Ingress hostname | `nil` (Required when Ingress is enabled) |
| `server.ingress.annotations` | Annotations applied to the Ingress resource | `true` |
| `server.ingress.path` | Ingress path | `/` |
| `server.ingress.pathtype` | Ingress PathType | `nil` |
| `server.ingress.tls` | Ingress TLS configuration | `{}` |
| `server.ingress.tls.secretName` | Name of the secret containing the ingress certificate | `{}` |
| `server.resources` | Server compute resources | `{}` |
| `server.livenessProbe` | Server liveness probe configuration | Check `values.yaml` file |
| `server.readinessProbe` | Server readiness probe configuration | Check `values.yaml` file |
| `server.service.type` | Kubernetes Service type | `ClusterIP` |
| `server.service.ports` | Kubernetes Service type | Check `values.yaml` file |
| `server.serviceAccount.create` | Create a dedicated Service Account for Server | `true` |
| `server.serviceAccount.name` | Name of the dedicated Service Account for Server | `""` |
| `server.serviceAccount.annotations` | Annotations to apply on the dedicated Service Account for Server | `{}` |
| `server.deploymentAnnotations` | Annotations to apply on the Deployment | `{}` |
| `server.schedulerName` | Scheduler name to use | `nil` |
| `server.strategy` | Update Strategy | `nil` |
| `server.podAnnotations` | Annotations to apply on the Server Pod | `nil` |
| `server.podLabels` | Labels to apply on the Server Pod | `nil` |
| `server.extraInitContainers` | Extra `initContainers` to inject into the Deployment | `nil` |
| `server.priorityClassName` | Name of the Priority Class | `nil` |
| `server.nodeSelector` | Node Selector | `nil` |
| `server.dnsConfig` | DNS Configuration for the pod | `nil` |
| `server.securityContext` | Pod security context | `nil` |
| `server.tolerations` | Tolerations applied to the pod | `nil` |
| `server.affinity` | Pod affinity | `nil` |
| `server.attestation_storage.enabled` | Enable attestation storage | `false` |
| `server.attestation_storage.bucket` | Attestation storage bucket | `file:///var/run/attestations` |
| `server.attestation_storage.persistence.enabled` | Enable persistent storage for file based attestation | `true` |
| `server.attestation_storage.persistence.annotations` | Annotations to apply on the _PersistentVolumeClaim_ | `{}` |
| `server.attestation_storage.persistence.storageClassName` | Name of the Storage Class | `nil` |
| `server.attestation_storage.persistence.size` | Storage size to request | `5Gi` |
| `server.attestation_storage.persistence.existingClaim` | Name of the exist_PersistentVolumeClaim_ing  to use for storage | `""` |
| `server.attestation_storage.persistence.accessModes` | Access modes to request for the _PersistentVolumeClaim_ | `["ReadWriteOnce"]` |


### Trillian Log Server

| Parameter                 | Description                                     | Default                                                 |
|---------------------------|-------------------------------------------------|---------------------------------------------------------|
| `trillianLogServer.enabled`    | Deploy the Trillian Log Server component                    | `true`                                                   |
| `trillianLogServer.replicaCount` | Number of replicas to deploy | `1` |
| `trillianLogServer.extraArgs` | Extra container args  | `{}` |
| `trillianLogServer.name` | Name of the Trillian Log Server component | `trillian-log-server` |
| `trillianLogServer.port` | Hostname of the Server instance | `8091` |
| `trillianLogServer.image.repository` | Repository of the Trillian Log Server image | `gcr.io/trillian-opensource-ci/log_server` |
| `trillianLogServer.image.pullPolicy` | Trillian Log Server image pull policy | `IfNotPresent` |
| `trillianLogServer.image.version` | Trillian Log Server tag or image ID | `5e12fb368c8fd19e10aeb5a5cf785107f8069c08` |
| `trillianLogServer.resources` | Trillian Log Server compute resources | `{}` |
| `trillianLogServer.livenessProbe` | Trillian Log Server liveness probe configuration | Check `values.yaml` file |
| `trillianLogServer.readinessProbe` | Trillian Log Server readiness probe configuration | Check `values.yaml` file |
| `trillianLogServer.service.type` | Kubernetes Service type | `ClusterIP` |
| `trillianLogServer.service.ports` | Kubernetes Service type | Check `values.yaml` file |
| `trillianLogServer.serviceAccount.create` | Create a dedicated Service Account for Redis | `true` |
| `trillianLogServer.serviceAccount.name` | Name of the dedicated Service Account for Redis | `""` |
| `trillianLogServer.serviceAccount.annotations` | Annotations to apply on the dedicated Service Account for the Trillian Log Server | `{}` |
| `trillianLogServer.deploymentAnnotations` | Annotations to apply on the Deployment | `{}` |
| `trillianLogServer.schedulerName` | Scheduler name to use | `nil` |
| `trillianLogServer.strategy` | Update Strategy | `nil` |
| `trillianLogServer.podAnnotations` | Annotations to apply on the Trillian Log Server Pod | `nil` |
| `trillianLogServer.podLabels` | Labels to apply on the Trillian Log Server Pod | `nil` |
| `trillianLogServer.extraInitContainers` | Extra `initContainers` to inject into the Deployment | `nil` |
| `trillianLogServer.priorityClassName` | Name of the Priority Class | `nil` |
| `trillianLogServer.nodeSelector` | Node Selector | `nil` |
| `trillianLogServer.dnsConfig` | DNS Configuration for the pod | `nil` |
| `trillianLogServer.securityContext` | Pod security context | `nil` |
| `trillianLogServer.tolerations` | Tolerations applied to the pod | `nil` |
| `trillianLogServer.affinity` | Pod affinity | `nil` |

### Trillian Log Signer

| Parameter                 | Description                                     | Default                                                 |
|---------------------------|-------------------------------------------------|---------------------------------------------------------|
| `trillianLogSigner.enabled`    | Deploy the Trillian Log Signer component                    | `true`                                                   |
| `trillianLogSigner.replicaCount` | Number of replicas to deploy | `1` |
| `trillianLogSigner.extraArgs` | Extra container args  | `{}` |
| `trillianLogSigner.name` | Name of the Trillian Log Signer component | `trillian-log-signer` |
| `trillianLogSigner.image.repository` | Repository of the Trillian Log Signer image | `gcr.io/trillian-opensource-ci/log_signer` |
| `trillianLogSigner.image.pullPolicy` | Trillian Log Signer image pull policy | `IfNotPresent` |
| `trillianLogSigner.image.version` | Trillian Log Signer tag or image ID | `5e12fb368c8fd19e10aeb5a5cf785107f8069c08` |
| `trillianLogSigner.resources` | Trillian Log Signer compute resources | `{}` |
| `trillianLogSigner.livenessProbe` | Trillian Log Signer liveness probe configuration | Check `values.yaml` file |
| `trillianLogSigner.readinessProbe` | Trillian Log Signer readiness probe configuration | Check `values.yaml` file |
| `trillianLogSigner.service.type` | Kubernetes Service type | `ClusterIP` |
| `trillianLogSigner.service.ports` | Kubernetes Service type | Check `values.yaml` file |
| `trillianLogSigner.serviceAccount.create` | Create a dedicated Service Account for Redis | `true` |
| `trillianLogSigner.serviceAccount.name` | Name of the dedicated Service Account for Redis | `""` |
| `trillianLogSigner.serviceAccount.annotations` | Annotations to apply on the dedicated Service Account for the Trillian Log Signer | `{}` |
| `trillianLogSigner.deploymentAnnotations` | Annotations to apply on the Deployment | `{}` |
| `trillianLogSigner.schedulerName` | Scheduler name to use | `nil` |
| `trillianLogSigner.strategy` | Update Strategy | `nil` |
| `trillianLogSigner.podAnnotations` | Annotations to apply on the Trillian Log Signer Pod | `nil` |
| `trillianLogSigner.podLabels` | Labels to apply on the Trillian Log Signer Pod | `nil` |
| `trillianLogSigner.extraInitContainers` | Extra `initContainers` to inject into the Deployment | `nil` |
| `trillianLogSigner.priorityClassName` | Name of the Priority Class | `nil` |
| `trillianLogSigner.nodeSelector` | Node Selector | `nil` |
| `trillianLogSigner.dnsConfig` | DNS Configuration for the pod | `nil` |
| `trillianLogSigner.securityContext` | Pod security context | `nil` |
| `trillianLogSigner.tolerations` | Tolerations applied to the pod | `nil` |
| `trillianLogSigner.affinity` | Pod affinity | `nil` |

## MySQL Credentials

Credentials for running (when deployed) and connecting to MySQL are stored in a secret resource. The _passsword_ and _root password_ are automatically generated when not provided.

_Note:_ If you plan to perform an upgrade of the chart, be sure to specify these values explicitly. 

An existing secret containing credentials for MySQL can be provided by passing the `mysql.auth.existingSecret` parameter. This secret must have the following keys:

* `mysql-password` - Password for connecting to MySQL
* `mysql-root-password` - Root Password (required when deploying MySQL)


## Integration with External Components

By Default, the chart deploys all required services. However, configurations can be applied to offload certain services, such as Redis and MySQL externally.

To disable the deployment of Redis or MySQL, pass the `redis.enabled=false` and/or `mysql.enabled=false`. Provide the hostname and port of the external resource using the `<redis|mysql>.hostname` and `<redis|mysql>.port` parameters.

## Ingress

To enabled access from external resources, an Ingress resource is created. The configuration necessary for each Ingress resource is primarily dependent on the specific Ingress Controller being used. In most cases, implementation specific configuration is specified as annotations on the Ingress resources. These can be applied using the `server.ingress.annotations` parameter.
