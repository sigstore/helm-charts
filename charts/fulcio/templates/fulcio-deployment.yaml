apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ template "fulcio.fullname" . }}
{{ include "fulcio.namespace" . | indent 2 }}
  labels:
    {{- include "fulcio.labels" . | nindent 4 }}
spec:
  replicas: {{ .Values.server.replicaCount }}
  selector:
    matchLabels:
      {{- include "fulcio.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      labels:
        {{- include "fulcio.selectorLabels" . | nindent 8 }}
    spec:
      serviceAccountName: {{ template "fulcio.serviceAccountName" . }}
      # This doesn't actually use Kubernetes credentials, so don't mount them in.
      automountServiceAccountToken: {{ .Values.server.serviceAccount.mountToken }}
      containers:
        - name: {{ template "fulcio.fullname" . }}
          image: "{{ template "fulcio.image" .Values.server.image }}"
          imagePullPolicy: "{{ .Values.server.image.pullPolicy }}"
          ports:
            - containerPort: {{ .Values.server.args.port}}
          args:
            - "serve"
            - "--port={{ .Values.server.args.port}}"
            - "--ca={{ .Values.server.args.certificateAuthority }}"
            {{- if eq .Values.server.args.certificateAuthority "googleca" }}
            - "--gcp_private_ca_parent={{ .Values.server.args.gcp_private_ca_parent }}"
            {{- end }}
            {{- if eq .Values.server.args.certificateAuthority "pkcs11ca" }}
            - "--hsm-caroot-id={{ .Values.server.args.hsm_caroot_id }}"
            {{- end }}
            {{- if eq .Values.server.args.certificateAuthority "aws-hsm-root-ca-path" }}
            - "--aws-hsm-root-ca-path={{ .Values.server.args.aws_hsm_root_ca_path }}"
            {{- end }}
            {{- if eq .Values.server.args.certificateAuthority "fileca" }}
            - "--fileca-key"
            - "/var/run/fulcio-secrets/key.pem"
            - "--fileca-cert"
            - "/var/run/fulcio-secrets/cert.pem"
            - "--fileca-key-passwd"
            - "$(PASSWORD)"
            {{- end }}
            - "--ct-log-url=http://{{ .Values.ctlog.name }}.{{ .Values.ctlog.namespace.name }}.svc/sigstorescaffolding"
          {{- if eq .Values.server.args.certificateAuthority "fileca" }}
          env:
            - name: PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ template "fulcio.secret" . }}
                  key: password
          {{- end }}
          volumeMounts:
            - name: fulcio-config
              mountPath: /etc/fulcio-config
            - name: oidc-info
              mountPath: /var/run/fulcio
           {{- if eq .Values.server.args.certificateAuthority "fileca" }}
            - name: fulcio-cert
              mountPath: "/var/run/fulcio-secrets"
              readOnly: true
           {{- end }}
      volumes:
        - name: fulcio-config
          configMap:
            name: {{ template "fulcio.config" . }}
        - name: oidc-info
          projected:
            sources:
              - configMap:
                  name: kube-root-ca.crt
                  items:
                    - key: ca.crt
                      path: ca.crt
                      mode: 0666
        {{- if eq .Values.server.args.certificateAuthority "fileca" }}
        - name: fulcio-cert
          secret:
            secretName: {{ template "fulcio.secret" . }}
            items:
              - key: private
                path: key.pem
              - key: cert
                path: cert.pem
        {{- end }}